{% extends 'usuario/base.html' %}

{% block content %}
<style>
    .reserva-layout { margin-top: 1.5rem; }
    .habitacion-img { width: 100%; height: 260px; object-fit: cover; border-radius: .5rem; }
    .info-chip { display:inline-block; padding: .25rem .5rem; border-radius: 999px; background:#f1f3f5; font-size:.85rem; margin-right:.5rem; }
    #room3d { width: 100%; height: 380px; border-radius: .5rem; overflow: hidden; background: #eef2f7; }
    .btn-reservar { background: linear-gradient(135deg,#ffd166,#fca311); border:none; color:#222; font-weight:700; padding:.75rem 1.25rem; border-radius:.65rem; box-shadow: 0 6px 14px rgba(252,163,17,.25); transition: transform .12s ease, box-shadow .2s ease; }
    .btn-reservar:hover { transform: translateY(-1px); box-shadow:0 10px 18px rgba(252,163,17,.35); color:#111; }
    .card-soft { border:0; box-shadow: 0 6px 20px rgba(0,0,0,.06); border-radius: .75rem; }
    @media (max-width: 991.98px) { #room3d{ height: 320px; } }
    @media (max-width: 575.98px) { .habitacion-img{ height: 200px; } }
    label.required::after{ content:' *'; color:#e03131; }
    .form-section-title{ font-weight:700; font-size:1.05rem; color:#343a40; }
    .mini-muted{ color:#6c757d; font-size:.9rem; }
    .badge-estado{ font-size:.75rem; }
    .precio { font-weight: 800; color:#0b7285; }
    .resumen-item { display:flex; align-items:center; justify-content:space-between; padding:.35rem 0; }
</style>

<div class="container reserva-layout">
    <div class="row g-4 align-items-stretch">
        <!-- Columna izquierda: Imagen, especificaciones y 3D -->
        <div class="col-12 col-lg-6 d-flex flex-column gap-3">
            <div class="card card-soft">
                <div class="card-body">
                    {% set uimg = media_url(habitacion.imagen) if habitacion.imagen else url_for('static', filename='img/default.jpg') %}
                    <img class="habitacion-img mb-3" src="{{ uimg }}" alt="{{ habitacion.nombre }}" onerror="this.onerror=null;this.src='{{ url_for('static', filename='img/default.jpg') }}'">
                    <h4 class="mb-1">{{ habitacion.nombre }}</h4>
                    <div class="mini-muted">ID Habitación #{{ habitacion.id }}</div>
                    <div class="d-flex align-items-center mt-2 mb-2 flex-wrap">
                        <span class="info-chip"><i class="bi bi-people me-1"></i>{{ habitacion.cupo_personas }} personas</span>
                        <span class="info-chip"><i class="bi bi-cash-coin me-1"></i><span class="precio">${{ '{:,.0f}'.format(habitacion.precio or 0) }}</span> COP/noche</span>
                        <span class="info-chip"><i class="bi bi-circle-half me-1"></i> <span class="badge rounded-pill text-bg-{{ 'success' if habitacion.estado=='Disponible' else 'secondary' }} badge-estado">{{ habitacion.estado }}</span></span>
                    </div>
                    <p class="mb-0">{{ habitacion.descripcion or 'Sin descripción' }}</p>
                </div>
            </div>

            <div class="card card-soft">
                <div class="card-body">
                    <h5 class="mb-3">Vista 3D de la habitación</h5>
                    <div id="room3d"></div>
                    <div class="mini-muted mt-2">Consejos: Arrastra para rotar • Scroll para zoom • Toca para móvil</div>
                </div>
            </div>
        </div>

        <!-- Columna derecha: Formulario -->
        <div class="col-12 col-lg-6 d-flex">
            <div class="card card-soft w-100">
                <div class="card-body">
                    <form method="POST" action="{{ url_for('hospedaje_usuario.reservar_habitacion', habitacion_id=habitacion.id) }}" novalidate>
                        <!-- Resumen de habitación dentro del formulario (solo lectura) -->
                        <div class="mb-3">
                            <div class="form-section-title mb-2">Información de la habitación</div>
                            <div class="resumen-item"><span>ID</span><span>#{{ habitacion.id }}</span></div>
                            <div class="resumen-item"><span>Nombre</span><span>{{ habitacion.nombre }}</span></div>
                            <div class="resumen-item"><span>Precio</span><span class="precio">${{ '{:,.0f}'.format(habitacion.precio or 0) }} COP</span></div>
                            <div class="resumen-item"><span>Cupo</span><span>{{ habitacion.cupo_personas }} personas</span></div>
                        </div>

                        <input type="hidden" name="habitacion_id" value="{{ habitacion.id }}">

                                    <div class="row g-3 align-items-end">
                                        <div class="col-12 col-md-6">
                                            <label class="form-label required">Check-in</label>
                                            <input id="resv-checkin" type="date" class="form-control" name="check_in" required>
                                        </div>
                                        <div class="col-12 col-md-6">
                                            <label class="form-label required">Check-out</label>
                                            <input id="resv-checkout" type="date" class="form-control" name="check_out" required>
                                        </div>
                                        <div class="col-12">
                                            <div id="resv-summary" class="mini-muted"></div>
                                        </div>
                                    </div>

                        <hr class="my-4">

                        <div class="form-section-title mb-2">Datos del huésped</div>
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label required">Nombre completo</label>
                                <input type="text" class="form-control" id="nombre" name="nombre" placeholder="Tu nombre y apellidos" required>
                            </div>
                            <div class="col-12 col-md-6">
                                <label class="form-label required">Tipo de documento</label>
                                <select class="form-select" id="tipoDocumento" name="tipoDocumento" required>
                                    <option value="" selected disabled>Selecciona una opción</option>
                                    <option value="Cédula de ciudadanía">Cédula de ciudadanía</option>
                                    <option value="Cédula de extranjería">Cédula de extranjería</option>
                                    <option value="Pasaporte">Pasaporte</option>
                                </select>
                            </div>
                            <div class="col-12 col-md-6">
                                <label class="form-label required">Número de documento</label>
                                <input type="text" inputmode="numeric" pattern="[0-9A-Za-z\-\.]+" class="form-control" id="numeroDocumento" name="numeroDocumento" placeholder="Ej. 1234567890" required>
                            </div>
                            <div class="col-12 col-md-6">
                                <label class="form-label required">Teléfono</label>
                                <input type="tel" class="form-control" id="telefono" name="telefono" placeholder="Celular o fijo" required>
                            </div>
                            <div class="col-12 col-md-6">
                                <label class="form-label required">Correo electrónico</label>
                                <input type="email" class="form-control" id="correo" name="correo" placeholder="tucorreo@ejemplo.com" required>
                            </div>
                            <div class="col-12">
                                <label class="form-label required">Procedencia</label>
                                <input type="text" class="form-control" id="procedencia" name="procedencia" placeholder="Ciudad / País" required>
                            </div>
                        </div>

                        <hr class="my-4">
                        
                        <div class="form-section-title mb-2">Acompañante (opcional)</div>
                        <div class="mb-3">
                            <button type="button" class="btn btn-outline-primary btn-sm" id="copyToGuest" onclick="copyCompanionToGuest()">
                                <i class="bi bi-arrow-up me-1"></i>Usar datos del acompañante como huésped principal
                            </button>
                        </div>
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label">Nombre completo</label>
                                <input type="text" class="form-control" id="nombre2" name="nombre2" placeholder="Nombre y apellidos del acompañante">
                            </div>
                            <div class="col-12 col-md-6">
                                <label class="form-label">Tipo de documento</label>
                                <select class="form-select" id="tipoDocumento2" name="tipoDocumento2">
                                    <option value="" selected>—</option>
                                    <option value="Cédula de ciudadanía">Cédula de ciudadanía</option>
                                    <option value="Cédula de extranjería">Cédula de extranjería</option>
                                    <option value="Pasaporte">Pasaporte</option>
                                </select>
                            </div>
                            <div class="col-12 col-md-6">
                                <label class="form-label">Número de documento</label>
                                <input type="text" inputmode="numeric" pattern="[0-9A-Za-z\-\.]+" class="form-control" id="numeroDocumento2" name="numeroDocumento2" placeholder="Ej. 9876543210">
                            </div>
                            <div class="col-12 col-md-6">
                                <label class="form-label">Teléfono</label>
                                <input type="tel" class="form-control" id="telefono2" name="telefono2" placeholder="Celular o fijo">
                            </div>
                            <div class="col-12 col-md-6">
                                <label class="form-label">Correo electrónico</label>
                                <input type="email" class="form-control" id="correo2" name="correo2" placeholder="correo@ejemplo.com">
                            </div>
                            <div class="col-12">
                                <label class="form-label">Procedencia</label>
                                <input type="text" class="form-control" id="procedencia2" name="procedencia2" placeholder="Ciudad / País">
                            </div>
                        </div>

                        <div class="d-grid mt-4">
                            <button id="btn-reservar" class="btn btn-reservar" type="submit">
                                <i class="bi bi-calendar2-check me-2"></i><span id="btn-reservar-text">Confirmar reserva y continuar al pago</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Three.js para el modelado 3D (versión del ejemplo) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
{# Configuración 3D por habitación inyectada desde el servidor #}
{% set _name = (habitacion.nombre or '').lower() %}
{% set _plan = (habitacion.plan or '').lower() %}
{% set _suite = 'suite' in _name %}
{% set _deluxe = 'deluxe' in _name or 'premium' in _name or _plan=='oro' %}
{% set _cap = habitacion.cupo_personas or 1 %}
{% set _beds = 2 if _cap >= 3 or _plan=='oro' else 1 %}
{% set _bedsize = 'king' if (_suite or _plan=='oro') else ('queen' if _deluxe or _cap >= 3 else 'double') %}
{% set _hasDesk = True if (_suite or _deluxe or _plan in ['oro','plata']) else False %}
{% set _hasWardrobe = True %}
{% set _hasCurtains = True %}
{% set _hasAC = True if (_suite or _deluxe or _plan in ['oro','plata']) else False %}
{% set _hasCeilingLights = True %}
{% set _dims = {'w': 12, 'd': 12, 'h': 7} if _plan=='oro' else ({'w': 11, 'd': 11, 'h': 6.5} if _plan=='plata' else {'w': 10, 'd': 10, 'h': 6}) %}
{# Intentar parsear caracteristicas si vienen como JSON para ajustar #}
{% set _car_json = None %}
{# Normalizar a string para evitar errores si viene como número/objeto #}
{% set _car_str = (habitacion.caracteristicas|string) if habitacion.caracteristicas is not none else '' %}
{% if _car_str and _car_str.strip().startswith('{') %}
    {% set _car_json = _car_str %}
{% endif %}
<script id="room3d-config" type="application/json">
{
    "beds": {{ _beds }},
    "bedSize": "{{ _bedsize }}",
    "hasDesk": {{ 'true' if _hasDesk else 'false' }},
    "hasWardrobe": {{ 'true' if _hasWardrobe else 'false' }},
    "hasCurtains": {{ 'true' if _hasCurtains else 'false' }},
    "hasAC": {{ 'true' if _hasAC else 'false' }},
    "hasCeilingLights": {{ 'true' if _hasCeilingLights else 'false' }},
    "palette": "{{ 'warm' if _suite or _deluxe else 'neutral' }}",
    "dims": {"w": {{ _dims.w }}, "d": {{ _dims.d }}, "h": {{ _dims.h }}},
    "plan": "{{ habitacion.plan or '' }}"{% if _car_json %},
    "caracteristicas": {{ _car_json|safe }}{% endif %}
}
</script>
<script>
    // Muestreo simple de color promedio de la imagen de la habitación
    (function(){
        try{
            var imgEl = document.querySelector('.habitacion-img');
            if(!imgEl) return;
            var img = new Image(); img.crossOrigin = 'anonymous'; img.src = imgEl.currentSrc || imgEl.src;
            img.onload = function(){
                var c=document.createElement('canvas'); var w=img.naturalWidth||img.width, h=img.naturalHeight||img.height; if(!w||!h) return;
                var s = Math.max(1, Math.floor(Math.sqrt((w*h)/4096))); // reducir a ~64x64
                c.width = Math.max(1, Math.floor(w/s)); c.height = Math.max(1, Math.floor(h/s));
                var ctx=c.getContext('2d'); ctx.drawImage(img,0,0,c.width,c.height);
                var data=ctx.getImageData(0,0,c.width,c.height).data; var r=0,g=0,b=0,n=0;
                for(var i=0;i<data.length;i+=4){ var rr=data[i], gg=data[i+1], bb=data[i+2], aa=data[i+3]; if(aa<128) continue; r+=rr; g+=gg; b+=bb; n++; }
                if(n>0){ r=Math.round(r/n); g=Math.round(g/n); b=Math.round(b/n);
                    var toHex=function(v){return ('0'+v.toString(16)).slice(-2)};
                    var hex=parseInt(toHex(r)+toHex(g)+toHex(b),16);
                    window.__ROOM_TINT__ = hex;
                    // derivar colores de pared/suelo: pared más clara, piso más cálido/oscuro
                    var lighten=function(v,p){ var rr=(v>>16)&255, gg=(v>>8)&255, bb=v&255; rr=Math.min(255,Math.round(rr+(255-rr)*p)); gg=Math.min(255,Math.round(gg+(255-gg)*p)); bb=Math.min(255,Math.round(bb+(255-bb)*p)); return (rr<<16)|(gg<<8)|bb; };
                    var darken=function(v,p){ var rr=(v>>16)&255, gg=(v>>8)&255, bb=v&255; rr=Math.max(0,Math.round(rr*(1-p))); gg=Math.max(0,Math.round(gg*(1-p))); bb=Math.max(0,Math.round(bb*(1-p))); return (rr<<16)|(gg<<8)|bb; };
                    window.__ROOM_DOMINANT__ = { wall: lighten(hex, 0.6), floor: darken(hex, 0.35) };
                }
            };
        }catch(e){}
    })();
</script>
<script>
    (function() {
                const container = document.getElementById('room3d');
        if (!container || !window.THREE) return;

        let scene, camera, renderer;
        let targetRotationY = 0, targetRotationX = 0; let isDragging=false, mouseX=0, mouseY=0;
                let conf = { beds:1, bedSize:'double', hasDesk:false, hasWardrobe:true, hasCurtains:true, hasAC:false, hasCeilingLights:true, palette:'neutral', dims:{w:10,d:10,h:6}, plan:'' };
                try {
                    const el = document.getElementById('room3d-config');
                    if (el) conf = JSON.parse(el.textContent);
                    // Mapear caracteristicas si vienen en JSON
                    if (conf && conf.caracteristicas && typeof conf.caracteristicas === 'object'){
                        const car = conf.caracteristicas;
                        if (car.beds != null) conf.beds = parseInt(car.beds) || conf.beds;
                        if (car.camas != null) conf.beds = parseInt(car.camas) || conf.beds;
                        const bsz = (car.bedSize || car.cama_tam || car.cama_tipo || '').toString().toLowerCase();
                        if (bsz.includes('king')) conf.bedSize = 'king';
                        else if (bsz.includes('queen')) conf.bedSize = 'queen';
                        else if (bsz) conf.bedSize = 'double';
                        if (car.hasDesk != null) conf.hasDesk = !!car.hasDesk;
                        if (car.escritorio != null) conf.hasDesk = !!car.escritorio;
                        if (car.hasWardrobe != null) conf.hasWardrobe = !!car.hasWardrobe;
                        if (car.guardarropa != null) conf.hasWardrobe = !!car.guardarropa;
                        if (car.hasCurtains != null) conf.hasCurtains = !!car.hasCurtains;
                        if (car.cortinas != null) conf.hasCurtains = !!car.cortinas;
                        if (car.hasAC != null) conf.hasAC = !!car.hasAC;
                        if (car.aire != null) conf.hasAC = !!car.aire;
                        if (car.hasCeilingLights != null) conf.hasCeilingLights = !!car.hasCeilingLights;
                        if (car.luces_techo != null) conf.hasCeilingLights = !!car.luces_techo;
                        if (car.dims && typeof car.dims === 'object'){
                            conf.dims.w = car.dims.w || conf.dims.w;
                            conf.dims.d = car.dims.d || conf.dims.d;
                            conf.dims.h = car.dims.h || conf.dims.h;
                        }
                    }
                } catch(e) {}

        function init() {
            scene = new THREE.Scene();
                        scene.background = new THREE.Color(conf.palette === 'warm' ? 0xf2eee6 : 0xf3f7fb);

                        const { width, height } = container.getBoundingClientRect();
                        camera = new THREE.PerspectiveCamera(70, width/height, 0.1, 1000);
                        camera.position.set(0, 5.6, 14);
            camera.lookAt(0,2,0);

            renderer = new THREE.WebGLRenderer({ antialias:true });
            renderer.setPixelRatio(window.devicePixelRatio || 1);
            renderer.setSize(width, height);
            renderer.shadowMap.enabled = true;
            container.innerHTML = '';
            container.appendChild(renderer.domElement);

            // Luces con tinte derivado de la imagen
                        const tint = window.__ROOM_TINT__ || (conf.palette==='warm'?0xffd8b5:0xdde7ff);
                        scene.add(new THREE.AmbientLight(0xffffff, .72));
                        const dir = new THREE.DirectionalLight(0xffffff, .8); dir.position.set(5,10,5); dir.castShadow=true; scene.add(dir);
                        const warm = new THREE.PointLight(tint, .38); warm.position.set(-3,3,-3); scene.add(warm);

                        createRoom();
                        createBeds(conf.beds, conf.bedSize);
                        createNightstands(conf.beds);
                        if (conf.hasWardrobe) createWardrobeWall();
                        if (conf.hasDesk) createDeskArea();
                        createWindow();
                        if (conf.hasCurtains) createCurtains();
                        createDoor();
                        if (conf.hasCeilingLights) createCeilingLights();
                        if (conf.hasAC) createACUnit();
                        createRug();

            container.addEventListener('mousedown', onDown); container.addEventListener('mousemove', onMove); window.addEventListener('mouseup', onUp);
            container.addEventListener('touchstart', onTouchStart, {passive:true}); container.addEventListener('touchmove', onTouchMove, {passive:true}); container.addEventListener('touchend', onUp);
            window.addEventListener('resize', onResize);

            animate();
        }

        function onResize(){ const r=container.getBoundingClientRect(); camera.aspect=r.width/r.height; camera.updateProjectionMatrix(); renderer.setSize(r.width, r.height); }
        function onDown(e){ isDragging=true; mouseX=e.clientX; mouseY=e.clientY; }
        function onMove(e){ if(!isDragging) return; const dx=e.clientX-mouseX, dy=e.clientY-mouseY; targetRotationY += dx*0.005; targetRotationX += dy*0.005; mouseX=e.clientX; mouseY=e.clientY; }
        function onUp(){ isDragging=false; }
        function onTouchStart(e){ if(e.touches.length===1){ isDragging=true; mouseX=e.touches[0].clientX; mouseY=e.touches[0].clientY; } }
        function onTouchMove(e){ if(e.touches.length===1 && isDragging){ const dx=e.touches[0].clientX-mouseX, dy=e.touches[0].clientY-mouseY; targetRotationY+=dx*0.005; targetRotationX+=dy*0.005; mouseX=e.touches[0].clientX; mouseY=e.touches[0].clientY; } }

        function createRoom(){
            const floorColor = (window.__ROOM_DOMINANT__ && window.__ROOM_DOMINANT__.floor) ? window.__ROOM_DOMINANT__.floor : 0x8b7355;
            const wallColor = (window.__ROOM_DOMINANT__ && window.__ROOM_DOMINANT__.wall) ? window.__ROOM_DOMINANT__.wall : 0xf0efe8;
            const floor = new THREE.Mesh(new THREE.PlaneGeometry(conf.dims.w,conf.dims.d), new THREE.MeshStandardMaterial({color:floorColor, roughness:.85}));
            floor.rotation.x = -Math.PI/2; floor.receiveShadow = true; scene.add(floor);
            const wallMat = new THREE.MeshStandardMaterial({color:wallColor, side:THREE.DoubleSide});
                        const back = new THREE.Mesh(new THREE.PlaneGeometry(conf.dims.w,conf.dims.h), wallMat); back.position.set(0,conf.dims.h/2,-conf.dims.d/2); scene.add(back);
                        const left = new THREE.Mesh(new THREE.PlaneGeometry(conf.dims.d,conf.dims.h), wallMat); left.rotation.y=Math.PI/2; left.position.set(-conf.dims.w/2,conf.dims.h/2,0); scene.add(left);
                        const right = new THREE.Mesh(new THREE.PlaneGeometry(conf.dims.d,conf.dims.h), wallMat); right.rotation.y=-Math.PI/2; right.position.set(conf.dims.w/2,conf.dims.h/2,0); scene.add(right);
                        const roof = new THREE.Mesh(new THREE.PlaneGeometry(conf.dims.w,conf.dims.d), new THREE.MeshStandardMaterial({color:0xffffff})); roof.rotation.x=Math.PI/2; roof.position.y=conf.dims.h; scene.add(roof);
        }
                function createBeds(count, size){
                        const spacing = (conf.plan && conf.plan.toLowerCase()==='oro') ? 5.2 : ((conf.plan && conf.plan.toLowerCase()==='plata') ? 4.8 : 4.5);
                        for(let b=0;b<count;b++){
                            const g=new THREE.Group();
                            const dims = size==='king'?{w:4.2,l:3.2}:{w:(size==='queen'?3.8:3.2), l:(size==='queen'?2.9:2.6)};
                            const base=new THREE.Mesh(new THREE.BoxGeometry(dims.w,.5,dims.l), new THREE.MeshStandardMaterial({color:0x8b4513})); base.position.y=.25; base.castShadow=true; g.add(base);
                            const mat=new THREE.Mesh(new THREE.BoxGeometry(dims.w-0.2,.4,dims.l-0.2), new THREE.MeshStandardMaterial({color:0xffffff})); mat.position.y=.7; mat.castShadow=true; g.add(mat);
                            const pillows = size==='king'?3:2;
                            for(let i=0;i<pillows;i++){ const p=new THREE.Mesh(new THREE.BoxGeometry(.8,.2,.6), new THREE.MeshStandardMaterial({color:0xe6e6fa})); p.position.set(-dims.w/2+0.8+i*(dims.w/(pillows)),1,-dims.l/2+0.7); p.castShadow=true; g.add(p); }
                            const head=new THREE.Mesh(new THREE.BoxGeometry(dims.w,1.5,.2), new THREE.MeshStandardMaterial({color:0x4f3828})); head.position.set(0,1.25,-dims.l/2); head.castShadow=true; g.add(head);
                            g.position.set((b-(count-1)/2)*spacing,0,-2);
                            scene.add(g);
                        }
                }
                function createNightstands(count){
                    for(let b=0;b<count;b++){
                        const x=(b-(count-1)/2)*4.5 - 2.6; // al lado izquierdo de cada cama
                        const g=new THREE.Group(); const body=new THREE.Mesh(new THREE.BoxGeometry(.9,1,.7), new THREE.MeshStandardMaterial({color:0x8b4513})); body.position.y=.5; body.castShadow=true; g.add(body); const dr=new THREE.Mesh(new THREE.BoxGeometry(.8,.3,.05), new THREE.MeshStandardMaterial({color:0x654321})); dr.position.set(0,.6,.35); dr.castShadow=true; g.add(dr); g.position.set(x,0,-2); scene.add(g);
                    }
                }
        function createLamp(){ const g=new THREE.Group(); const base=new THREE.Mesh(new THREE.CylinderGeometry(.1,.15,.05,16), new THREE.MeshStandardMaterial({color:0x333})); g.add(base); const pole=new THREE.Mesh(new THREE.CylinderGeometry(.02,.02,.8,8), new THREE.MeshStandardMaterial({color:0x333})); pole.position.y=.4; g.add(pole); const shade=new THREE.Mesh(new THREE.CylinderGeometry(.2,.25,.3,16), new THREE.MeshStandardMaterial({color:0xffffcc, emissive:0xffff88, emissiveIntensity:.3})); shade.position.y=.95; g.add(shade); g.position.set(-3,1,-2); scene.add(g); }
                function createWindow(){ const g=new THREE.Group(); const frame=new THREE.Mesh(new THREE.BoxGeometry(2.6,2.8,.1), new THREE.MeshStandardMaterial({color:0x8b4513})); g.add(frame); const glass=new THREE.Mesh(new THREE.PlaneGeometry(2.4,2.6), new THREE.MeshStandardMaterial({color:0x87ceeb, transparent:true, opacity:.28})); glass.position.z=.06; g.add(glass); g.position.set(3.2,3,-(conf.dims.d/2-0.05)); scene.add(g); }
                function createCurtains(){ const g=new THREE.Group(); const cloth=new THREE.Mesh(new THREE.PlaneGeometry(2.8,2.9,20,2), new THREE.MeshStandardMaterial({color:0x444444, side:THREE.DoubleSide})); cloth.position.set(3.2,2.4,-(conf.dims.d/2-0.02)); cloth.castShadow=true; g.add(cloth); const rod=new THREE.Mesh(new THREE.CylinderGeometry(0.03,0.03,3,8), new THREE.MeshStandardMaterial({color:0x222})); rod.rotation.z=Math.PI/2; rod.position.set(3.2,3.0,-(conf.dims.d/2-0.0)); g.add(rod); scene.add(g); }
                function createWardrobeWall(){ const g=new THREE.Group(); const totalW=conf.dims.w-1.2; const startX=-totalW/2; for(let i=0;i<5;i++){ const panel=new THREE.Mesh(new THREE.BoxGeometry(totalW/5 - .05,2.3,.1), new THREE.MeshStandardMaterial({color:0xf5f1e8})); panel.position.set(startX + (i+0.5)* (totalW/5), 2.0, -(conf.dims.d/2-0.05)); g.add(panel);} const shelf=new THREE.Mesh(new THREE.BoxGeometry(totalW, .1, .2), new THREE.MeshStandardMaterial({color:0x6b4f3a})); shelf.position.set(0,1.4,-(conf.dims.d/2-0.06)); g.add(shelf); scene.add(g); }
                function createDeskArea(){ const g=new THREE.Group(); const top=new THREE.Mesh(new THREE.BoxGeometry(3.5,.1,.6), new THREE.MeshStandardMaterial({color:0x3b3b3b})); top.position.set(-(conf.dims.w/2)+2.2,1.0,-1.5); g.add(top); const leg=new THREE.Mesh(new THREE.BoxGeometry(.1,0.9,.6), new THREE.MeshStandardMaterial({color:0x3b3b3b})); leg.position.set(-(conf.dims.w/2)+0.5,0.55,-1.5); g.add(leg); const mon=new THREE.Mesh(new THREE.BoxGeometry(.9,.55,.05), new THREE.MeshStandardMaterial({color:0x222})); mon.position.set(-(conf.dims.w/2)+1.2,1.5,-1.5); g.add(mon); scene.add(g); }
                function createCeilingLights(){ const n = (conf.plan && conf.plan.toLowerCase()==='oro') ? 4 : 3; for(let i=0;i<n;i++){ const lamp=new THREE.Mesh(new THREE.ConeGeometry(0.12,0.25,12), new THREE.MeshStandardMaterial({color:0xdddddd})); lamp.position.set(-2+i*2.2, conf.dims.h-0.2, -1.0); scene.add(lamp);} }
                function createACUnit(){ const ac=new THREE.Mesh(new THREE.BoxGeometry(1.2,.4,.4), new THREE.MeshStandardMaterial({color:0xeeeeee})); ac.position.set(conf.dims.w/2 - 0.6, conf.dims.h-0.7, 2.8); scene.add(ac); }
        function createDoor(){ const g=new THREE.Group(); const frame=new THREE.Mesh(new THREE.BoxGeometry(1.2,2.5,.1), new THREE.MeshStandardMaterial({color:0x654321})); g.add(frame); const handle=new THREE.Mesh(new THREE.SphereGeometry(.05,16,16), new THREE.MeshStandardMaterial({color:0xffd700})); handle.position.set(.4,0,.1); g.add(handle); g.position.set(-3.5,1.25,4.95); g.rotation.y=Math.PI; scene.add(g); }
                function createRug(){ const rug=new THREE.Mesh(new THREE.PlaneGeometry(3.4,2.2), new THREE.MeshStandardMaterial({color:0xb89b88, roughness:1})); rug.rotation.x=-Math.PI/2; rug.position.set(0,.01,1); scene.add(rug); }

        function animate(){ requestAnimationFrame(animate); camera.position.x += (Math.sin(targetRotationY)*12 - camera.position.x)*.1; camera.position.z += (Math.cos(targetRotationY)*12 - camera.position.z)*.1; camera.position.y += (5 - targetRotationX*5 - camera.position.y)*.1; camera.lookAt(0,2,0); renderer.render(scene,camera); }

        init();
    })();
</script>

    <script>
        // Cálculo dinámico de noches y total estimado
        (function(){
            const checkin = document.getElementById('resv-checkin');
            const checkout = document.getElementById('resv-checkout');
            const summary = document.getElementById('resv-summary');
            const submitBtn = document.getElementById('btn-reservar');
            const submitText = document.getElementById('btn-reservar-text');
            const precioNoche = {{ (habitacion.precio or 0)|int }};
            const habitacionId = {{ habitacion.id }};

            function formatCOP(val){
                try { return new Intl.NumberFormat('es-CO').format(val); } catch(e){ return val; }
            }

            function setMins(){
                const today = new Date(); today.setHours(0,0,0,0);
                const isoToday = today.toISOString().slice(0,10);
                if (checkin && !checkin.value) checkin.min = isoToday;
                if (checkout){
                    const base = checkin.value ? new Date(checkin.value) : today;
                    base.setDate(base.getDate()+1);
                    const isoMinOut = base.toISOString().slice(0,10);
                    checkout.min = isoMinOut;
                    if (checkout.value && checkout.value < isoMinOut) checkout.value = '';
                }
            }

            async function update(){
                setMins();
                        if (!checkin.value || !checkout.value){
                    summary.textContent = '';
                    submitBtn.disabled = false; // permitimos y el backend aplica mínimo 1 noche
                            if (submitText) submitText.textContent = 'Confirmar reserva y continuar al pago';
                    return;
                }
                const inD = new Date(checkin.value);
                const outD = new Date(checkout.value);
                const ms = outD - inD;
                const nights = Math.round(ms / (1000*60*60*24));
                        if (isNaN(nights) || nights <= 0){
                    summary.innerHTML = '<span class="text-danger">Selecciona una fecha de salida posterior al check-in.</span>';
                    submitBtn.disabled = true;
                            if (submitText) submitText.textContent = 'Confirmar reserva y continuar al pago';
                    return;
                }
                const total = Math.max(1, nights) * precioNoche;
                // Consultar disponibilidad al backend
                try {
                    const params = new URLSearchParams({ check_in: checkin.value, check_out: checkout.value });
                    const resp = await fetch(`/hospedaje/disponibilidad/${habitacionId}?${params.toString()}`, { headers: { 'Accept': 'application/json' } });
                    const data = await resp.json();
                    if (data && data.ok && data.available){
                        summary.innerHTML = `Noches: <strong>${nights}</strong> · Total estimado: <strong>$${formatCOP(total)} COP</strong> <span class="badge text-bg-success ms-2">Disponible</span>`;
                        submitBtn.disabled = false;
                        if (submitText) submitText.textContent = `Confirmar reserva — $${formatCOP(total)} COP`;
                    } else {
                        const reason = (data && data.error) ? ` (${data.error})` : '';
                        summary.innerHTML = `<span class="text-danger">No disponible para estas fechas${reason}. Prueba con otro rango.</span>`;
                        submitBtn.disabled = true;
                        if (submitText) submitText.textContent = 'Confirmar reserva y continuar al pago';
                    }
                } catch (e) {
                    // Si falla la consulta, no bloquear, pero avisar
                    summary.innerHTML = `Noches: <strong>${nights}</strong> · Total estimado: <strong>$${formatCOP(total)} COP</strong> <span class="text-muted ms-2">(No se pudo verificar disponibilidad)</span>`;
                    submitBtn.disabled = false;
                    if (submitText) submitText.textContent = `Confirmar reserva — $${formatCOP(total)} COP`;
                }
            }

            if (checkin && checkout){
                setMins();
                ['change','input'].forEach(evt => {
                    checkin.addEventListener(evt, update);
                    checkout.addEventListener(evt, update);
                });
                update();
            }
        })();

        // Función para copiar datos del acompañante al huésped principal
        function copyCompanionToGuest() {
            const companionFields = {
                nombre2: 'nombre',
                tipoDocumento2: 'tipoDocumento', 
                numeroDocumento2: 'numeroDocumento',
                telefono2: 'telefono',
                correo2: 'correo',
                procedencia2: 'procedencia'
            };
            
            let hasData = false;
            
            // Verificar si hay datos en el acompañante
            for (const companionField in companionFields) {
                const companionElement = document.getElementById(companionField);
                if (companionElement && companionElement.value.trim() !== '') {
                    hasData = true;
                    break;
                }
            }
            
            if (!hasData) {
                alert('Por favor, completa primero los datos del acompañante para poder copiarlos.');
                return;
            }
            
            // Copiar datos
            let copiedFields = 0;
            for (const companionField in companionFields) {
                const companionElement = document.getElementById(companionField);
                const guestField = companionFields[companionField];
                const guestElement = document.getElementById(guestField);
                
                if (companionElement && guestElement && companionElement.value.trim() !== '') {
                    guestElement.value = companionElement.value;
                    copiedFields++;
                }
            }
            
            if (copiedFields > 0) {
                // Cambiar temporalmente el texto del botón para confirmar la acción
                const copyBtn = document.getElementById('copyToGuest');
                const originalText = copyBtn.innerHTML;
                copyBtn.innerHTML = '<i class="bi bi-check2 me-1"></i>¡Datos copiados!';
                copyBtn.className = 'btn btn-success btn-sm';
                
                // Restaurar el botón después de 2 segundos
                setTimeout(() => {
                    copyBtn.innerHTML = originalText;
                    copyBtn.className = 'btn btn-outline-primary btn-sm';
                }, 2000);
            }
        }
    </script>

{% endblock %}

